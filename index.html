<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>Panel Unificado - PER & PIE Bebidas</title>

<!-- Librería para Iconos -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
  :root{
      --bg:#f3f4f6;
      --panel:#1e293b;
      --card:#fff;
      --text-main: #111827;
      --text-muted: #6b7280;
      --primary:#007bff;
      --accent-pink: #f472b6;
      --accent-green: #10b981;
      --border-color: #e5e7eb;
      
      /* Alturas fijas para los paneles */
      --header-height: 60px;
      --navbar-height: 70px;
      --nav-active-color: #007bff; 
      --nav-inactive-color: #9ca3af; 
      
      /* Nuevo color Mercado Pago */
      --mp-blue: #009ee3;
      --whatsapp-green: #25D366;
  }
  
  body {
      margin:0;
      font-family:'Inter',Segoe UI,Arial,Helvetica,sans-serif;
      background:var(--bg);
      color:var(--text-main);
      display:flex;
      flex-direction: column; 
      height:100vh; /* Altura fija de la ventana */
      overflow:hidden; /* Evitamos scroll en el body, lo manejamos en main */
  }

  /* --- HEADER SUPERIOR FIJO --- */
  .top-header {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: var(--header-height);
      background: #fff;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      padding: 0 1rem;
      box-sizing: border-box;
  }

  .brand-title {
      font-size: 1.2rem;
      font-weight: 900;
      text-transform: uppercase;
      margin: 0;
      background: linear-gradient(90deg, #ec4899, #8b5cf6, #f97316);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      letter-spacing: 0.5px;
      text-align: center;
  }

  .status-container {
      position: absolute;
      right: 15px;
      top: 0;
      height: 100%;
      display: flex;
      align-items: center;
      gap: 10px; /* Espacio entre las luces */
  }
  
  #birthdayLight {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #f97316; /* Naranja */
      box-shadow: 0 0 6px #f97316;
      display: none; /* Oculto por defecto */
      cursor: help;
  }

  #statusLight {
      width:12px;
      height:12px;
      border-radius:50%;
      background:red;
      box-shadow:0 0 6px red;
  }

  /* --- MAIN AREA (CONTENIDO CENTRAL) --- */
  .main {
      position: absolute;
      top: var(--header-height);
      bottom: var(--navbar-height);
      left: 0;
      right: 0;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      padding: 16px;
      box-sizing: border-box;
      padding-bottom: 40px; 
  }

  /* Estilos específicos para INICIO (fondo negro completo) */
  body:has(#inicio.active) .main { 
      padding: 0; 
      background-color: #000; 
  }
  
  .birthday-notifications {
      padding: 16px;
      display: none; 
      flex-direction: column;
      gap: 12px;
      background-color: #000; 
  }
  .birthday-card {
      background-color: var(--card);
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      border: 1px solid var(--border-color);
      display: flex;
      flex-direction: column;
      gap: 8px;
  }
  .birthday-card-header {
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--text-main);
  }
  .birthday-card-body {
      font-size: 0.95rem;
      color: var(--text-muted);
      font-weight: 500;
  }
  .birthday-card-footer {
      display: flex;
      gap: 10px;
      margin-top: 8px;
  }
  .btn-whatsapp-birthday {
      flex-grow: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 8px 12px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.9rem;
      background-color: var(--whatsapp-green);
      color: white;
      text-decoration: none;
      text-align: center;
  }
  .btn-whatsapp-birthday:disabled {
      background-color: #9ca3af;
      cursor: not-allowed;
  }
  .btn-dismiss-birthday {
      flex-grow: 1;
      padding: 8px 12px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.9rem;
      background-color: var(--border-color);
      color: var(--text-muted);
  }

  /* --- BARRA DE NAVEGACION --- */
  .bottom-navbar {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      height: var(--navbar-height);
      background: #fff;
      border-top: 1px solid var(--border-color);
      display: flex;
      justify-content: space-around;
      align-items: center;
      z-index: 1000;
      padding-bottom: env(safe-area-inset-bottom);
      box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
  }

  .nav-btn {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: none;
      border: none;
      color: var(--nav-inactive-color); 
      font-size: 0.7rem;
      font-weight: 600;
      cursor: pointer;
      height: 100%;
      gap: 4px;
      text-decoration: none; 
      padding: 5px 0;
  }

  .nav-btn i { font-size: 1.2rem; margin-bottom: 2px; }
  .nav-btn.active { color: var(--nav-active-color); }

  .table-responsive {
      width: 100%;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      margin-bottom: 1rem;
      border-radius: 8px;
      border: 1px solid var(--border-color);
  }
  
  h1{margin-top:0;font-size:1.5rem;font-weight:800;color:#1f2937;margin-bottom:1.5rem}
  .modern-card{background:var(--card);border-radius:16px;padding:20px;box-shadow:0 4px 6px -1px rgba(0,0,0,0.05),0 2px 4px -2px rgba(0,0,0,0.05);border:1px solid #f0f0f0; margin-bottom: 20px;}
  .modern-label{display:block;font-size:.9rem;font-weight:600;color:#374151;margin-bottom:6px}
  .modern-input{width:100%;padding:12px 16px;background-color:#f9fafb;border:1px solid var(--border-color);border-radius:10px;font-size:.95rem;color:#1f2937;box-sizing:border-box;transition:border-color .2s,box-shadow .2s;outline:none}
  .modern-input:focus{border-color:var(--primary);box-shadow:0 0 0 3px rgba(59,130,246,0.1);background-color:#fff}
  .btn-modern{width:100%;padding:12px;border-radius:10px;font-weight:600;font-size:1rem;cursor:pointer;border:none;transition:filter .2s;text-align:center}
  .btn-modern:hover{filter:brightness(.95)}
  .btn-blue{background-color:#007bff;color:white} 
  .btn-pink{background-color:#ff69b4;color:white;font-size:1.5rem;line-height:1;display:flex;justify-content:center;align-items:center} 
  .btn-gray{background-color:#d1d5db;color:#374151}
  
  .ventas-grid{display:grid;grid-template-columns:1fr 380px;gap:24px;align-items:start}
  @media(max-width:900px){
      .ventas-grid{grid-template-columns:1fr; gap: 15px;} 
  }
  
  .cart-empty{text-align:center;color:#9ca3af;padding:20px;font-style:italic}
  .summary-row{display:flex;justify-content:space-between;margin-bottom:8px;align-items:center}
  .summary-label{color:#4b5563;font-weight:500}
  .summary-value{font-weight:700;color:#111827;font-size:1.1rem}
  .summary-value.discount{color:#ef4444}
  .summary-total{margin-top:16px;padding-top:16px;border-top:1px solid var(--border-color)}
  .summary-total .summary-label{font-size:1.2rem;font-weight:800;color:#059669;text-transform:uppercase}
  .summary-total .summary-value{font-size:1.5rem;font-weight:900;color:#059669}
  
  .modern-table{width:100%;border-collapse:collapse;margin-top:16px}
  .modern-table th{text-align:left;padding:8px;font-size:.85rem;color:#6b7280;font-weight:700;border-bottom:1px solid var(--border-color)}
  .modern-table td{padding:10px 8px;border-bottom:1px solid #f3f4f6;font-size:.95rem}
  .btn-icon-small{background:none;border:none;cursor:pointer;padding:4px;color:#ef4444;transition:transform .2s}
  .btn-icon-small:hover{transform:scale(1.2)}
  
  .card-container{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:20px}
  .combo-card-advanced{background:var(--card);border-radius:12px;box-shadow:0 4px 6px -1px rgba(0,0,0,0.1);padding:16px;display:flex;flex-direction:column;border:1px solid #e5e7eb}
  .combo-img-box{width:100%;height:180px;border-radius:8px;overflow:hidden;margin-bottom:12px;background:#f3f4f6}
  .combo-img-box img{width:100%;height:100%;object-fit:cover}
  .combo-info{flex-grow:1;display:flex;flex-direction:column}
  .combo-title{font-size:1.15rem;font-weight:700;color:#111827;margin:0 0 4px 0}
  .combo-price{font-size:1.5rem;font-weight:700;color:#10b981;margin:0 0 12px 0}
  .combo-items-list{list-style:disc;padding-left:20px;margin:0;font-size:.9rem;color:#4b5563;flex-grow:1}
  .combo-actions{margin-top:16px;padding-top:12px;border-top:1px solid #e5e7eb;display:flex;gap:8px;align-items:center}
  .btn-icon-text{display:flex;align-items:center;justify-content:center;gap:6px;padding:8px 12px;border-radius:6px;border:none;cursor:pointer;font-weight:600;font-size:.9rem;flex:1;transition:background .2s}
  .btn-whatsapp-combo{background-color:#25D366;color:white}
  .btn-image-combo{background-color:#8b5cf6;color:white;max-width:50px}
  
  table.stock-table{width:100%;border-collapse:collapse;background:var(--card);}
  table.stock-table th,table.stock-table td{padding:.7rem;border-bottom:1px solid #e6e9ee;text-align:left; white-space: nowrap;}
  table.stock-table th{background:#f8fafc;color:#111;font-weight:700}
  .img-cell img{width:56px;height:56px;object-fit:cover;border-radius:6px}
  .categoria-header{background:linear-gradient(90deg,#ec4899,#8b5cf6);color:#fff;font-weight:700;padding:.6rem;border-radius:8px}
  .sin-stock{color:#f87171;font-weight:700}

  .section{display:none}
  .section.active{display:block; animation: fadeIn 0.3s;}
  @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
  
  /* Estilos Inicio */
  #inicio.active {
      min-height: 100%; 
      display: flex;
      flex-direction: column;
      justify-content: flex-start; 
      align-items: center;
      text-align: center;
      box-sizing: border-box;
      background: #000;
      color: #fff;
      padding-bottom: 40px; 
  }
  .inicio-container { 
      width: 100%; 
      max-width: 400px; 
      display: flex; 
      flex-direction: column; 
      align-items: center; 
      gap: 20px; 
      padding: 20px;
      box-sizing: border-box;
  }
  .inicio-welcome-text { font-size: 1rem; line-height: 1.5; font-weight: 600; color: #f0f0f0; margin: 0; padding: 0 10px; }
  
  .inicio-logo { 
      width: 90%;        
      max-width: 500px;  
      height: auto; 
      object-fit: contain; 
      margin: 20px 0; 
  }
  
  .inicio-code-section { width: 100%; display: flex; flex-direction: column; align-items: center; gap: 10px; }
  .inicio-code-input { width: 100%; height: 45px; border-radius: 25px; border: none; background: #fff; color: #000; font-size: 1rem; text-align: center; font-weight: 700; }
  .inicio-code-label { font-size: 1rem; font-weight: 700; color: #2dd4bf; }
  .btn-instagram-outline { background: transparent; border: 1px solid #555; color: #fff; padding: 10px 20px; border-radius: 50px; text-decoration: none; display: flex; align-items: center; gap: 10px; font-size: 0.9rem; margin-top: 10px; width: 100%; justify-content: center; box-sizing: border-box; }

  .space-y-4 > * + *{margin-top:1rem} 
  .btn{padding:10px 14px;border-radius:8px;border:none;cursor:pointer;font-weight:600} 
  .btn-secondary{background:#64748b;color:white}
  #floatingCard{position:fixed;left:50%;transform:translateX(-50%);bottom:85px;width:min(980px,96%);max-width:980px;z-index:99999;display:none;padding:0 10px;box-sizing:border-box}
  #floatingCard .inner{display:flex;gap:16px;align-items:center;justify-content:space-between;padding:14px;border-radius:12px;box-shadow:0 8px 30px rgba(2,6,23,0.12);background:linear-gradient(90deg,#fff,#f8fafc)}
  #floatingCard.success .inner{border-left:6px solid #10b981}
  #floatingCard.error .inner{border-left:6px solid #ef4444;background:linear-gradient(90deg,#fff7f7,#fff)}
  .floating-content{display:flex;gap:12px;align-items:center}
  .floating-code{font-family:monospace;font-weight:800;font-size:1.1rem;padding:6px 10px;border-radius:8px;background:#f3f4f6}
  .floating-info{display:flex;flex-direction:column;align-items:flex-start}
  .floating-actions{display:flex;flex-direction:column;gap:8px;min-width:140px}
  .floating-actions button{width:100%;padding:8px 14px;border-radius:6px;font-weight:600;cursor:pointer;border:none;transition:background-color .2s;font-size:.9rem;display:flex;align-items:center;justify-content:center;gap:6px}
  .btn-whatsapp{background:#25D366;color:white}
  .btn-copy{background:#3b82f6;color:white}
  .btn-close-float{background:#9ca3af;color:white}
  
  #descuento-feedback, #combo-stock-warning {
      font-size: .85rem;
      font-weight: 600;
      margin-top: 4px;
      text-align: left;
      min-height: 1.2rem;
      display: block;
      line-height: 1.4;
  }
  #combo-stock-warning {
      color: #f97316; /* Naranja de advertencia */
  }
  
  .feedback-success{color:#10b981}
  .feedback-error{color:#ef4444}
  
  /* Estilos para el resumen de venta */
  #ventaResumenCard{position:fixed;top:50%;left:50%;transform:translate(-50%,-45%);background:#ffffff;border-radius:14px;box-shadow:0 8px 30px rgba(0,0,0,0.25);padding:20px;width:min(90%,500px);max-height:80vh;overflow-y:auto;z-index:99999;display:none;font-size:.95rem;opacity:0;transition:all .3s ease-in-out}
  #ventaResumenCard.show{display:block;opacity:1;transform:translate(-50%,-50%)}
  #ventaResumenCard .totales{margin-top:12px;font-weight:700}
  #ventaResumenCard .acciones{margin-top:16px;display:flex;gap:8px;justify-content:space-between; flex-wrap: wrap;}
  #ventaResumenCard table{width:100%; border-collapse: collapse; margin-top: 10px;}
  #ventaResumenCard th, #ventaResumenCard td {border-bottom: 1px dashed #eee; padding: 6px 0;}
  #ventaResumenCard th {font-size: 0.9em; color: #4b5563;}
  #ventaResumenCard td:nth-child(2), #ventaResumenCard td:nth-child(3) { text-align: right; }

  .btn-pago-link{background:#007bff;color:white; border:none; padding:8px 14px; border-radius:6px; font-weight:600; cursor:pointer;}
  .btn-pago-link:hover{background:#0056b3;}

  .modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background-color:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:2000;opacity:0;visibility:hidden;transition:opacity .3s,visibility .3s}
  .modal-overlay.active{opacity:1;visibility:visible}
  .modal-content{background-color:white;padding:2rem;border-radius:.75rem;width:90%;max-width:500px;transform:scale(.95);transition:transform .3s;max-height:90vh;overflow-y:auto}
  .modal-overlay.active .modal-content{transform:scale(1)}

  /* --- GENERADOR DE ETIQUETAS --- */
  #label-generator-modal .modal-content {
      max-width: 400px;
      padding: 1rem;
  }
  #etiqueta-area-captura-final {
      width: 340px;
      height: 620px;
      margin: 10px auto;
      padding: 10px 5px;
      background-color: #f3f4f6;
      display: flex;
      justify-content: center;
      align-items: center;
  }
  #etiqueta-visor-promo {
      width: 320px;
      height: 600px;
      position: relative;
      background-color: white;
      border-radius: 40px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      overflow: hidden;
      border: 1px solid #ddd;
      margin: 0;
  }
  #etiqueta-visor-promo::after {
      content: ''; position: absolute; top: 10px; left: 10px; right: 10px; bottom: 10px;
      background: linear-gradient(to bottom right, #FFD700, #FF66B2, #800080);
      border-radius: 35px; z-index: 1; pointer-events: none;
  }
  #etiqueta-visor-promo::before {
      content: ''; position: absolute; top: 14px; left: 14px; right: 14px; bottom: 14px;
      background-color: white; border-radius: 30px; z-index: 2; pointer-events: none;
  }
  #etiqueta-brand-text {
      position: absolute; top: 25px; width: 100%; text-align: center;
      font-size: 1.1em; font-weight: 900; z-index: 3; margin-bottom: 5px; color: #FFD700;
  }
  #etiqueta-contact-numbers {
      position: absolute; top: 45px; width: 100%; text-align: center;
      font-size: 0.9em; font-weight: 600; z-index: 3; color: #800080;
  }
  #etiqueta-visor-contenido {
      position: relative; z-index: 3; padding: 85px 35px 15px 35px;
      display: flex; flex-direction: column; align-items: center;
      height: 100%; justify-content: flex-start; text-align: center;
      box-sizing: border-box; 
  }
  
  #etiqueta-contenedor-imagen {
      width: 100%; max-height: 240px; min-height: 180px;
      flex-grow: 1; 
      overflow: hidden; display: flex;
      align-items: center; justify-content: center;
      margin-bottom: 5px; border-radius: 8px; background-color: white;
  }
  #etiqueta-visor-imagen {
      max-width: 100%; width: auto; height: 100%;
      object-fit: contain; display: block;
  }
  #etiqueta-text-block {
      width: 100%; padding: 0; display: flex;
      flex-direction: column; align-items: center; margin-top: 0;
      flex-shrink: 1; 
      min-height: 0; 
  }
  
  #etiqueta-promo-title {
      margin: 0 0 8px 0;
      font-size: 1.2em;
      font-weight: 900;
      color: #333;
      white-space: normal;
      word-wrap: break-word;
      line-height: 1.2;
      max-width: 100%;
  }
  #etiqueta-promo-price {
      margin: 0 0 12px 0;
      font-size: 2.5rem;
      line-height: 1.1;
      font-weight: 900;
      letter-spacing: -1px;
      width: 100%;
      padding: 0 5px;
      color: #FFD700;
  }
  #etiqueta-promo-description { 
      margin: 0 0 5px 0; 
      font-size: 1.1em; 
      line-height: 1.4; 
      font-weight: 500; 
      color: #555; 
  }
  
  #etiqueta-promo-list {
      list-style: none;
      margin: 15px 0 0 0;
      padding: 0 0 20px 0;
      text-align: left; width: 100%; max-width: 300px;
  }

  #etiqueta-promo-list li {
      font-size: 1em; line-height: 1.4; margin-bottom: 5px;
      color: #333;
  }
  #etiqueta-promo-list li span { color: #333; font-weight: 500; }

  .whatsapp-float{position:fixed;width:60px;height:60px;bottom:80px;right:20px;background-color:#25d366;color:#fff;border-radius:50%;text-align:center;font-size:28px;box-shadow:0 4px 10px rgba(0,0,0,0.3);z-index:1000;transition:transform .3s ease,box-shadow .3s ease;overflow:visible}
  .whatsapp-float:hover{transform:scale(1.1);box-shadow:0 6px 14px rgba(0,0,0,0.4)}
  .whatsapp-icon{width:32px;height:32px;margin-top:14px;filter:brightness(0) invert(1)}
  .whatsapp-tooltip{position:absolute;right:70px;top:50%;transform:translateY(-50%);background-color:#25d366;color:white;font-weight:600;padding:8px 14px;border-radius:20px;box-shadow:0 3px 8px rgba(0,0,0,0.2);opacity:0;pointer-events:none;transition:opacity .3s ease,right .3s ease;white-space:nowrap;font-family:sans-serif}
  #miniConsole,#statusIndicator{display:none!important}

   .modern-input option[disabled] {
      background: linear-gradient(90deg, #f472b6, #8b5cf6);
      /* Rosa y Lila */
      color: white !important;
      font-weight: bold;
      padding: 5px 10px;
  }

  /* --- NUEVOS ESTILOS CARRITO Y BUSCADOR --- */
  .radio-type-group { display: flex; align-items: center; gap: 15px; margin-bottom: 15px; }
  .radio-label { font-weight: 700; font-size: 0.95rem; display: flex; align-items: center; gap: 5px; cursor: pointer; }
  .radio-input { accent-color: #111827; transform: scale(1.2); }
  
  .search-container { position: relative; width: 100%; }
  .search-results-list {
      position: absolute; top: 100%; left: 0; right: 0;
      background: white; border: 1px solid #e5e7eb;
      border-radius: 0 0 10px 10px; max-height: 250px;
      overflow-y: auto; z-index: 500; display: none;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
  }
  .search-results-list.active { display: block; }
  .search-item-row {
      display: flex; justify-content: space-between; align-items: center;
      padding: 10px 15px; border-bottom: 1px solid #f3f4f6;
  }
  .search-item-row:hover { background-color: #f9fafb; }
  .item-info-text { display: flex; flex-direction: column; }
  .item-name { font-weight: 600; color: #111827; font-size: 0.95rem; }
  .item-price { color: #6b7280; font-size: 0.85rem; }
  
  /* Botón Azul Redondo con + */
  .btn-add-circle {
      width: 32px; height: 32px; border-radius: 50%;
      background: linear-gradient(135deg, #00b4db, #0083b0); /* Azul estilo imagen */
      color: white; border: none; font-size: 1.2rem;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer; transition: transform 0.2s;
      box-shadow: 0 2px 5px rgba(0,131,176,0.3);
  }
  .btn-add-circle:hover { transform: scale(1.1); }
  .btn-add-circle:active { transform: scale(0.95); }

  /* Controles de Cantidad < 1 > */
  .qty-control-wrapper { display: flex; align-items: center; justify-content: center; gap: 8px; }
  .btn-qty-arrow {
      background: none; border: none; font-size: 1.2rem;
      color: #3b82f6; font-weight: 900; cursor: pointer;
      padding: 0 5px;
  }
  .qty-display { font-weight: 700; font-size: 1rem; min-width: 20px; text-align: center; }
</style>

<!-- Librerías PDF y HTML2Canvas -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
<script src="https://sdk.mercadopago.com/js/v2"></script>

</head>
<body>
  
  <header class="top-header">
      <h2 class="brand-title">PER & PIE Bebidas</h2>
      <div class="status-container">
          <div id="birthdayLight" title="¡Hay un cumpleaños mañana!"></div>
          <div id="statusLight" title="Estado de conexión Supabase"></div>
      </div>
  </header>

  <div class="main">
    
    <!-- SECCIÓN INICIO -->
    <section id="inicio" class="section active">
      
      <div id="birthday-notifications-container" class="birthday-notifications">
          <!-- Las tarjetas de cumpleaños se cargarán aquí -->
      </div>

      <div class="inicio-container">
          <p class="inicio-welcome-text">"¡Hola! PER & PIE Bebidas te abre las puertas de un mundo de sabores y posibilidades. ¡Esperamos que encuentres lo que estás buscando!"</p>
          
          <img 
            id="logo-inicio-img"
            src="https://gblqjxnigwyjxohpacuq.supabase.co/storage/v1/object/public/Logo%20PER%20PIE/Photoroom-20251126_131457.png" 
            alt="Logo PER & PIE" 
            class="inicio-logo"
            onerror="this.src='https://placehold.co/350x350/000/fff?text=Error+Logo'" 
          >
          
          <div class="inicio-code-section">
              <div id="codigo-descuento-display" class="inicio-code-input" style="display: flex; align-items: center; justify-content: center; padding: 0 10px; box-sizing: border-box; line-height: 1.3; flex-wrap: wrap; gap: 5px 10px;">
                  <span id="codigo-descuento-placeholder" style="color: #6c757d;">Buscando código...</span>
              </div>
              <label for="codigo-descuento-display" class="inicio-code-label">Si hay un código, ¡ÚSALO!</label>
          </div>

          <a href="#" id="btn-instagram" target="_blank" class="btn-instagram-outline">
              <i class="fab fa-instagram"></i> Síguenos en Instagram
          </a>
      </div>
    </section>

    <!-- SECCIÓN STOCK -->
        <!-- SECCIÓN STOCK -->
    <section id="stock" class="section">
      <h1>Stock</h1>
      
      <!-- NUEVO CONTENEDOR DE CONTROLES -->
      <div style="display: flex; gap: 10px; margin-bottom: 15px; align-items: center; flex-wrap: wrap;">
          <!-- Botón (ahora sin margen inferior forzado para alinearse) -->
          <button id="btn-generar-pdf" class="btn btn-secondary" style="margin-bottom: 0; white-space: nowrap;">
            <i class="fas fa-file-pdf"></i> Generar Lista de Precios
          </button>
          
          <!-- Buscador con ícono -->
          <div style="flex-grow: 1; position: relative; min-width: 200px;">
              <i class="fas fa-search" style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #9ca3af;"></i>
              <input type="text" id="stock-search-input" class="modern-input" placeholder="Buscar producto por nombre o categoría..." style="padding-left: 35px; width: 100%;">
          </div>
      </div>

      <div class="table-responsive">
          <table id="tabla-stock" class="stock-table" aria-live="polite">
            <thead><tr><th>Imagen</th><th>Nombre</th><th>Precio</th></tr></thead>
            <tbody id="tabla-stock-body"></tbody>
          </table>
      </div>
    </section>

    <section id="combos" class="section">
      <h1>Combos Disponibles</h1>
      <div class="card-container" id="combosGuardados"></div>
    </section>

    <!-- SECCIÓN UNITE -->
    <section id="clientes" class="section">
      <div style="max-width:500px; margin: 0 auto;">
        <div class="modern-card">
          <h3 style="margin:0 0 10px 0;font-size:1.5rem; color:#111827;">Nuevo Cliente</h3>
          <p style="font-size: 0.95rem; color: var(--accent-pink); font-weight: 600; margin-bottom: 20px;">
            ¡Unite a PER & PIE Bebidas y obtené un código de descuento exclusivo para tu primera compra! ¡Salud!
          </p>
          <form id="form-cliente" class="space-y-4" autocomplete="off">
            <div>
                <label class="modern-label">Nombre y Apellido</label>
                <input id="cliente-nombre" class="modern-input" type="text" required
                       pattern="[a-zA-ZáéíóúÁÉÍÓÚñÑ\s]+"
                       title="Solo se permiten letras, espacios y acentos."
                       placeholder="Ingrese nombre completo">
            </div>
            <div>
                <label class="modern-label">Teléfono (WhatsApp)</label>
                <input id="cliente-telefono" class="modern-input" type="tel" required
                       pattern="[0-9]{8,15}"
                       title="Ingrese solo números (8 a 15 dígitos sin prefijo internacional ni 15)."
                       placeholder="Ej: 3425551234 (solo números)">
            </div>
            <div>
                <label class="modern-label">Fecha de Nacimiento</label>
                <input id="cliente-fecha-nacimiento" class="modern-input" type="date">
            </div>
            <div>
                <label class="modern-label">Dirección</label>
                <input id="cliente-direccion" class="modern-input" type="text" placeholder="Calle, Número, Ciudad">
            </div>
            <div style="padding-top:10px;">
              <button type="submit" id="btn-guardar-cliente" class="btn-modern btn-blue">Guardar Cliente</button>
            </div>
          </form>
        </div>
      </div>
    </section>

    <!-- SECCIÓN COMPRAS -->
    <section id="ventas" class="section">
      <h1>Compras</h1>
      <div class="ventas-grid">
          <div class="modern-card">
            <h3 style="margin:0 0 16px 0; font-size:1.2rem;">Carrito de Compra</h3>
            
            <div class="space-y-4">
                
                <div class="radio-type-group">
                    <span style="font-weight:700; font-size:0.9rem; color:#374151;">Tipo</span>
                    <label class="radio-label">
                        <input type="radio" name="tipoVenta" value="productos" checked class="radio-input"> PRODUCTOS
                    </label>
                    <label class="radio-label">
                        <input type="radio" name="tipoVenta" value="combos" class="radio-input"> COMBOS
                    </label>
                </div>

                <div class="search-container">
                    <label class="modern-label">Buscar Artículo</label>
                    <input id="venta-item-buscador" class="modern-input" type="text" placeholder="Escriba aquí para buscar..." autocomplete="off">
                    
                    <div id="search-results-list" class="search-results-list"></div>
                    <span id="combo-stock-warning"></span>
                </div>
                
                </div>

            <div class="table-responsive" style="margin-top:15px; border:none;">
                <table class="modern-table">
                    <thead>
                        <tr><th>Item</th><th>Precio</th><th>Cant.</th><th>Total</th><th></th></tr>
                    </thead>
                    <tbody id="tabla-carrito">
                        <tr><td colspan="5" class="cart-empty">El carrito está vacío</td></tr>
                    </tbody>
                </table>
            </div>
          </div>
          <!-- Resumen -->
          <div class="modern-card">
            <h3 style="margin:0 0 16px 0; font-size:1.2rem;">Resumen y Pago</h3>
            <form id="form-venta" class="space-y-4" onsubmit="return false;">

             <div>
    <label class="modern-label">Nombre y Apellido / Domicilio <span style="color:red">*</span></label>
    <span style="display:block; font-size:0.85rem; color:#6b7280; margin-bottom:6px; font-style:italic; font-family: 'Courier New', monospace;">Ejemplo: Juan Perez / Av. Peñaloza 7950</span>
    <input id="venta-cliente" class="modern-input" placeholder="Ingrese sus datos aquí..." required>
</div>

                <div><label class="modern-label">Descuento Aplicado</label><input id="venta-descuento-aplicado" class="modern-input" placeholder="Sin Descuento"><span id="descuento-feedback"></span></div>
                
                <div style="margin-top: 24px;">
                    <div class="summary-row"><span class="summary-label">Subtotal:</span><span id="venta-subtotal" class="summary-value">$0.00</span></div>
                    <div class="summary-row"><span class="summary-label">Descuento:</span><span id="venta-monto-descuento" class="summary-value discount">$0.00</span></div>
                    <div class="summary-row summary-total"><span class="summary-label">TOTAL:</span><span id="venta-total" class="summary-value">$0.00</span></div>
                </div>

                <div style="display:grid; grid-template-columns: 1fr; gap: 10px; margin-top: 20px;">
                  

                  
                  <div style="text-align:center; color: var(--text-muted); font-weight: 600; margin: 5px 0;">- o -</div>
    
                  <button id="btn-enviar-pedido-wa" class="btn-modern" style="background-color: var(--whatsapp-green); color: white;">
                      <i class="fas fa-list-alt" style="margin-right: 8px;"></i>Ver Resumen
                  </button>

                  <p style="font-size:0.85rem;color:#4b5563;margin-top:5px; text-align:center;">
                      ¿Quieres gestionar un pedido? Explora alternativas de pago, ¡contáctanos!
                  </p>
                  
                  <button id="btn-limpiar-venta-completa" class="btn-modern btn-gray" style="margin-top: 10px;">Limpiar Carrito</button>
                </div>

            </form>
          </div>
      </div>
    </section>
  </div>

  <nav class="bottom-navbar">
      <button class="nav-btn active" id="link-inicio">
          <i class="fas fa-home"></i>
          <span>Inicio</span>
      </button>
      <button class="nav-btn" id="link-stock">
          <i class="fas fa-box"></i>
          <span>Stock</span>
      </button>
      <button class="nav-btn" id="link-combos">
          <i class="fas fa-tags"></i>
          <span>Combos</span>
      </button>
      <button class="nav-btn" id="link-clientes">
          <i class="fas fa-users"></i>
          <span>Unite</span>
      </button>
      <button class="nav-btn" id="link-ventas">
          <i class="fas fa-cash-register"></i>
          <span>Compras</span>
      </button>
  </nav>

  <!-- Modales -->
  <div id="floatingCard" role="status" aria-live="polite"><div class="inner"><div class="floating-content"><div><div id="floatingTitle" style="font-weight:800">Notificación</div><div id="floatingMsg" class="muted" style="font-size:0.95rem;margin-top:6px"></div></div><div style="width:10px"></div><div class="floating-info"><div style="display:flex;gap:8px;align-items:center"><div class="floating-code" id="floatingCode">—</div><div style="font-size:0.95rem;"><div id="floatingPercent">—</div><div id="floatingVence" class="muted" style="font-size:0.85rem"></div></div></div><div style="font-size:0.85rem;color:#6b7280;margin-top:6px">Hay productos que ya tienen descuentos, por lo que no son acumulables.</div></div></div><div class="floating-actions"><button id="btn-whatsapp-send" class="btn-whatsapp"><i class="fab fa-whatsapp"></i> WhatsApp</button><button id="btn-copy-code" class="btn-copy"><i class="fas fa-copy"></i> Copiar Código</button><button id="btn-close-floating" class="btn-close-float"><i class="fas fa-times"></i> Cerrar</button></div></div></div>
  
  <!-- Modal de Resumen de Venta -->
  <div id="ventaResumenCard">
      <h3>Resumen de Pedido</h3>
      <div id="ventaResumenContenido"></div>
      <div class="acciones">
          <button id="btnVentaPagar" class="btn-pago-link" style="display:none;"><i class="fas fa-money-check-alt" style="margin-right: 6px;"></i> Pagar con Link</button>
          
          <button id="btnVentaWhatsApp" class="btn-whatsapp" style="border:none; padding:8px 14px; border-radius:6px; font-weight:600; cursor:pointer; color:white; background-color:#25d366; flex-grow: 2;">
            <i class="fab fa-whatsapp" style="margin-right: 6px;"></i>Confirmar por WhatsApp
          </button>
          <button id="btnVentaCompartir" class="btn-modern" style="background-color: #3b82f6; color: white; border:none; padding:8px 14px; border-radius:6px; font-weight:600; cursor:pointer; flex-grow: 1;">
            <i class="fas fa-share-alt" style="margin-right: 6px;"></i>Compartir
          </button>
          <button id="btnVentaCerrar" class="btn-secondary" style="border:none; padding:8px 14px; border-radius:6px; font-weight:600; cursor:pointer; color:white; background-color:#9ca3af; width: 100%; margin-top: 8px;">
            Cerrar y Limpiar
          </button>
      </div>
  </div>

  <!-- Modal Etiquetas -->
  <div id="label-generator-modal" class="modal-overlay">
    <div class="modal-content">
      <div id="etiqueta-area-captura-final">
          <div id="etiqueta-visor-promo">
              <div id="etiqueta-brand-text">PER & PIE Bebidas</div>
              <div id="etiqueta-contact-numbers">342 5993971 / 3483 483892</div>
              <div id="etiqueta-visor-contenido">
                  <div id="etiqueta-contenedor-imagen">
                      <img id="etiqueta-visor-imagen" src="" alt="Vista previa del combo">
                  </div>
                  <div id="etiqueta-text-block">
                      <h3 id="etiqueta-promo-title"></h3>
                      <h2 id="etiqueta-promo-price"></h2>
                      <p id="etiqueta-promo-description"></p>
                      <ul id="etiqueta-promo-list"></ul>
                  </div>
              </div>
          </div>
      </div>

      <div style="display:flex; justify-content:center; gap:16px; margin-top:16px;">
        <button id="btn-close-label" class="btn" style="background:#d1d5db; color:#333;">Cerrar</button>
        <button id="btn-download-label" class="btn-modern btn-blue" style="width:auto; padding:10px 20px;">
          <i class="fas fa-download" style="margin-right:8px;"></i>Descargar PNG
        </button>
      </div>
    </div>
  </div>

<!-- JAVASCRIPT -->
<script>
const statusLight = document.getElementById('statusLight');
function logMini(msg){ console.log(`[LOG] ${msg}`); }
function setStatus(color, text){
  statusLight.style.background = color;
  statusLight.style.boxShadow = `0 0 6px ${color}`;
  logMini(`Estado: ${text} (${color})`);
}

const sections = document.querySelectorAll('.section');
const navLinks = [
    { id: 'link-inicio', section: 'inicio' },
    { id: 'link-stock', section: 'stock' },
    { id: 'link-combos', section: 'combos' },
    { id: 'link-clientes', section: 'clientes' },
    { id: 'link-ventas', section: 'ventas' }
];
function switchView(targetSectionId) {
  sections.forEach(s => {
    const linkElement = document.getElementById(`link-${s.id}`);
    if (linkElement) linkElement.classList.remove('active');
    if (s.id === targetSectionId) {
      s.classList.add('active');
      if (linkElement) linkElement.classList.add('active');
    } else {
      s.classList.remove('active');
    }
  });
  document.querySelector('.main').scrollTop = 0; 
}
navLinks.forEach(linkInfo => {
    const linkElement = document.getElementById(linkInfo.id);
    if (linkElement) {
        linkElement.addEventListener('click', e => {
            e.preventDefault();
            switchView(linkInfo.section);
        });
    }
});

const SUPABASE_URL = 'https://gblqjxnigwyjxohpacuq.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdibHFqeG5pZ3d5anhvaHBhY3VxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEwODI2NjEsImV4cCI6MjA3NjY1ODY2MX0.u0Zo28kNHXtZP6Q18o7_D0W2TGi0771ORfnHFBgS5-8';

let productosCache = [];
let combosMasterCache = []; 
let combosCache = [];      
let supabaseClient = null; 
let globalPagoPorcentaje = 0;
let globalAdminWhatsApp = ''; 

// VARIABLES ACTUALIZADAS
// const itemSelect = document.getElementById('venta-item-selector'); // YA NO EXISTE
// const tipoSelect = document.getElementById('venta-tipo-item');     // YA NO EXISTE
const buscadorInput = document.getElementById('venta-item-buscador');
const resultsListDiv = document.getElementById('search-results-list'); // NUEVO
const comboWarningSpan = document.getElementById('combo-stock-warning');

async function loadSupabase(){
  if(window.supabase) return window.supabase;
  logMini('Cargando librería supabase-js...');
  const s = document.createElement('script');
  s.src = 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2';
  document.head.appendChild(s);
  await new Promise(r => { s.onload = r; s.onerror = () => r(); });
  window.supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
  return window.supabase;
}

async function cargarCodigoEspecialInicio(sbClient) {
  const displayCodigo = document.getElementById('codigo-descuento-display');
  const placeholderSpan = document.getElementById('codigo-descuento-placeholder'); 
 
  if (!displayCodigo || !placeholderSpan) {
      logMini('⚠️ Error: No se encontraron los elementos del display de código.');
      return;
  }
 
  try {
    const ahoraISO = new Date().toISOString();
    const { data, error } = await sbClient.from('descuentos').select('codigo, vencimiento').eq('nombre', 'PER & PIE').order('vencimiento', { ascending: false }).gt('vencimiento', ahoraISO).limit(1).maybeSingle();
    
    if (error) { 
      logMini('❌ Error código especial: ' + error.message); 
      if(placeholderSpan) placeholderSpan.textContent = "Error al cargar código";
      return; 
    }
    
    if (data && data.codigo && data.vencimiento) {
        const date = new Date(data.vencimiento);
        const dateOptions = { day: '2-digit', month: '2-digit', year: 'numeric' };
        const timeOptions = { hour: '2-digit', minute: '2-digit', hour12: false };
        const datePart = date.toLocaleDateString('es-AR', dateOptions);
        const timePart = date.toLocaleTimeString('es-AR', timeOptions);

        displayCodigo.innerHTML = `
          <span style="color: #007bff; font-weight: 900; font-size: 1.1rem; line-height: 1.2;">${data.codigo}</span>
          <span style="color: #ef4444; font-size: 0.9em; font-weight: 600; line-height: 1.2;">vence ${datePart} ${timePart} hs.</span>
        `;
        logMini(`✅ Código especial "${data.codigo}" cargado.`);
        return;
    }
    
    if(placeholderSpan) placeholderSpan.textContent = "No hay código activo";
 
  } catch (err) { 
    logMini('❌ Excepción cargando código especial.'); 
    if(placeholderSpan) placeholderSpan.textContent = "Error al cargar código";
  }
} 

async function checkAllBirthdays(sbClient) {
    if (!sbClient) {
        logMini('⚠️ Cliente Supabase no listo para verificar cumpleaños.');
        return;
    }

    const container = document.getElementById('birthday-notifications-container');
    const birthdayLight = document.getElementById('birthdayLight');
    if (container) container.innerHTML = '';
    if (birthdayLight) birthdayLight.style.display = 'none';

    try {
        const hoy = new Date();
        const manana = new Date(hoy);
        manana.setDate(hoy.getDate() + 1);

        const hoyMes = hoy.getMonth() + 1;
        const hoyDia = hoy.getDate();
        const mananaMes = manana.getMonth() + 1;
        const mananaDia = manana.getDate();

        const { data: clientes, error } = await sbClient
            .from('clientes')
            .select('id, nombre, telefono, fecha_nacimiento')
            .not('fecha_nacimiento', 'is', null);

        if (error) {
            logMini(`❌ Error al obtener clientes: ${error.message}`);
            return;
        }

        if (!clientes || clientes.length === 0) {
            logMini('No hay clientes con fechas de nacimiento para verificar.');
            return;
        }

        let upcomingBirthdayCount = 0;

        for (const cliente of clientes) {
            const parts = cliente.fecha_nacimiento.split('-');
            if (parts.length !== 3) continue; 

            const birthMonth = parseInt(parts[1], 10);
            const birthDay = parseInt(parts[2], 10);

            if (isNaN(birthMonth) || isNaN(birthDay)) continue;

            if (birthMonth === hoyMes && birthDay === hoyDia) {
                upcomingBirthdayCount++;
            }
            
            if (birthMonth === mananaMes && birthDay === mananaDia) {
                upcomingBirthdayCount++; 
            }
        }

        if (birthdayLight) {
            if (upcomingBirthdayCount > 0) {
                birthdayLight.style.display = 'block';
                birthdayLight.title = `¡${upcomingBirthdayCount} cliente(s) cumple(n) años hoy o mañana!`; 
            } else {
                birthdayLight.style.display = 'none';
            }
        }

    } catch (err) {
        logMini(`❌ Excepción al verificar cumpleaños: ${err.message}`);
        if(birthdayLight) birthdayLight.style.display = 'none';
    }
}

async function conectarYCargarTodo(){
  let conexionExitosa = false; // Bandera para saber si descargamos datos bien

  try{
    setStatus('yellow','CONECTANDO');
    logMini('Iniciando conexión a Supabase...');
    const sb = await loadSupabase();
    supabaseClient = sb;

    // Preparamos las peticiones
    const promConfig = sb.from('config')
      .select('config_instagram_url, config_pago_porcentaje, config_whatsapp_empleado, config_whatsapp_admin')
      .limit(1).maybeSingle();

    const promProductos = sb.from('productos')
      .select('id,categoria,nombre,imagen,precio1,stock,costo,ganancia1')
      .order('categoria', { ascending: true });

    const promCombos = sb.from('combos').select('*').order('id', { ascending: false });
    const promCodigoEspecial = cargarCodigoEspecialInicio(sb);
    const promCumpleanos = checkAllBirthdays(sb);

    // Ejecutamos todo junto
    const [resProd, resComb, _, resConfig, __] = await Promise.all([
        promProductos,
        promCombos,
        promCodigoEspecial,
        promConfig,
        promCumpleanos
    ]);

    // 1. VERIFICACIÓN DE DATOS (CONEXIÓN)
    if(resProd.error){ logMini('❌ Error productos: ' + resProd.error.message); }
    else {
        productosCache = resProd.data || [];
        logMini('✅ Productos cargados: ' + productosCache.length);
    }

    if(resComb.error){ logMini('❌ Error combos: ' + resComb.error.message); }
    else {
        combosMasterCache = resComb.data || [];
        logMini('✅ Combos cargados: ' + combosMasterCache.length);
    }

    // Configuración
    if (resConfig && resConfig.data) {
        if (resConfig.data.config_instagram_url) {
            const btnInsta = document.getElementById('btn-instagram');
            if(btnInsta) btnInsta.href = resConfig.data.config_instagram_url;
        }
        if (resConfig.data.config_pago_porcentaje) {
            globalPagoPorcentaje = Number(resConfig.data.config_pago_porcentaje);
        }
        let adminNumber = resConfig.data.config_whatsapp_admin || resConfig.data.config_whatsapp_empleado;
        if (adminNumber) {
            globalAdminWhatsApp = adminNumber.replace(/\D/g, '');
            logMini(`✅ WhatsApp Admin/Propietario cargado: ${globalAdminWhatsApp}`);
        }
    }

    // LOGICA CORREGIDA DEL ESTADO
    // Si tenemos datos de productos O combos, la conexión fue exitosa.
    if((resProd.data && !resProd.error) || (resComb.data && !resComb.error)){
        setStatus('green','CONECTADO');
        conexionExitosa = true; // ¡Marcamos que ya conectamos!
    } else {
        setStatus('red','DESCONECTADO');
    }

    // 2. RENDERIZADO E INTERFAZ (Separado para no afectar la luz verde)
    try {
        handleDataRefresh();
        initClientes(sb);
        if (typeof initVentas === 'function') initVentas(sb);
        setupRealtimeSubscriptions(sb);
    } catch (renderError) {
        console.error("Error al renderizar la interfaz:", renderError);
        logMini("⚠️ Conectado, pero hubo un error visual: " + renderError.message);
        // NO cambiamos a rojo aquí porque la conexión sí funcionó
    }

  } catch(err) {
    // Solo ponemos rojo si NO habíamos marcado la conexión como exitosa antes
    if (!conexionExitosa) {
        setStatus('red','DESCONECTADO');
    }
    logMini('❌ Excepción General: ' + err.message);
  }
}

function handleDataRefresh() {
    combosCache = filtrarCombosPorStock(combosMasterCache, productosCache);
    renderTable(productosCache);
    renderCombos(combosCache);
    if (typeof populateVentaSelector === 'function') {
        populateVentaSelector();
    }
}

function setupRealtimeSubscriptions(sbClient) {
    const canalProductos = sbClient.channel('public:productos')
        .on('postgres_changes', { event: '*', schema: 'public', table: 'productos' }, (payload) => {
            if (payload.eventType === 'INSERT') {
                productosCache.push(payload.new);
            } 
            else if (payload.eventType === 'UPDATE') {
                const index = productosCache.findIndex(p => p.id === payload.new.id);
                if (index > -1) {
                    productosCache[index] = { ...productosCache[index], ...payload.new };
                }
            } 
            else if (payload.eventType === 'DELETE') {
                productosCache = productosCache.filter(p => p.id !== payload.old.id);
            }
            
            productosCache.sort((a, b) => (a.categoria || '').localeCompare(b.categoria || ''));
            handleDataRefresh();
        })
        .subscribe();

    const canalCombos = sbClient.channel('public:combos')
        .on('postgres_changes', { event: '*', schema: 'public', table: 'combos' }, (payload) => {
            if (payload.eventType === 'INSERT') {
                combosMasterCache.push(payload.new);
            } 
            else if (payload.eventType === 'UPDATE') {
                const index = combosMasterCache.findIndex(c => c.id === payload.new.id);
                if (index > -1) {
                    combosMasterCache[index] = payload.new;
                }
            } 
            else if (payload.eventType === 'DELETE') {
                combosMasterCache = combosMasterCache.filter(c => c.id !== payload.old.id);
            }
            handleDataRefresh();
        })
        .subscribe();

    const canalClientes = sbClient.channel('public:clientes')
        .on('postgres_changes', { event: '*', schema: 'public', table: 'clientes' }, (payload) => {
            checkAllBirthdays(sbClient); 
        })
        .subscribe();
}

function filtrarCombosPorStock(combos, productos) {
    if (!productos || productos.length === 0) return []; 
    
    const stockMap = new Map();
    productos.forEach(p => {
        stockMap.set(p.id, p.stock || 0);
    });

    const combosDisponibles = [];

    combos.forEach(comboOriginal => {
        const combo = { ...comboOriginal }; 
        const items = combo.items || combo.productos || [];
        let maxCombosPosibles = Infinity; 

        if (items.length === 0) {
            maxCombosPosibles = 0; 
        }

        for (const item of items) {
            const productoEnCache = productos.find(p => p.nombre.toLowerCase().trim() === item.nombre.toLowerCase().trim());
            
            if (!productoEnCache) {
                maxCombosPosibles = 0; 
                break;
            }

            const cantidadRequerida = item.cantidad || 0;
            if (cantidadRequerida <= 0) continue; 

            if (!stockMap.has(productoEnCache.id)) {
                maxCombosPosibles = 0; 
                break; 
            }
            
            const stockDisponible = stockMap.get(productoEnCache.id);
            const posiblesParaEsteItem = Math.floor(stockDisponible / cantidadRequerida);
            
            maxCombosPosibles = Math.min(maxCombosPosibles, posiblesParaEsteItem);
        }

        if (maxCombosPosibles > 0 && isFinite(maxCombosPosibles)) {
            combo.stockCalculado = maxCombosPosibles; 
            combosDisponibles.push(combo); 
        }
    });

    return combosDisponibles;
}

function renderTable(products){
  const tbody = document.getElementById('tabla-stock-body');
  if (!tbody) return; 
  tbody.innerHTML = '';
  if(!products || products.length === 0){ tbody.innerHTML = '<tr><td colspan="3">Sin productos</td></tr>'; return; }
  const grouped = {};
  products.forEach(p=>{ const c = p.categoria || 'Sin categoría'; if(!grouped[c]) grouped[c] = []; grouped[c].push(p); });
  for(const c in grouped){
    const hr = document.createElement('tr');
    const hc = document.createElement('td');
    hc.colSpan = 3; hc.innerHTML = `<div class="categoria-header">${c}</div>`; hr.appendChild(hc); tbody.appendChild(hr);
    grouped[c].forEach(p=>{
      const tr = document.createElement('tr');
      const img = p.imagen || 'https://placehold.co/60x60';
      const stockCell = (p.stock === 0) ? '<span class="sin-stock">Sin stock</span>' : (typeof p.precio1 === 'number' ? '$' + p.precio1.toLocaleString('es-AR') : '-');
      tr.innerHTML = `<td class="img-cell"><img src="${img}" alt=""></td><td>${p.nombre}</td><td>${stockCell}</td>`;
      tbody.appendChild(tr);
    });
  }
}
function formatCurrency(amount) { return new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'ARS', minimumFractionDigits: 2 }).format(amount); }
function formatCurrencyForLabel(amount) { return new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'ARS', maximumFractionDigits: 0 }).format(amount); }

function renderCombos(combos){
  const cont = document.getElementById('combosGuardados');
  if (!cont) return; 
  cont.innerHTML = '';
  if(!combos || combos.length === 0){ cont.innerHTML = '<p>No hay combos disponibles en este momento.</p>'; return; }
  combos.forEach(c => {
    const card = document.createElement('div');
    card.className = 'combo-card-advanced';
    const items = c.items || c.productos || [];
    const itemsHtml = items.map(item => `<li>${item.cantidad} x ${item.nombre}</li>`).join('');
    const imgUrl = c.imagen || 'https://placehold.co/300x200/e2e8f0/adb5bd?text=Combo';
    card.innerHTML = `<div class="combo-img-box"><img src="${imgUrl}" alt="${c.nombre}"></div><div class="combo-info"><h4 class="combo-title">${c.nombre}</h4><p class="combo-price">${formatCurrency(c.precio)}</p><ul class="combo-items-list">${itemsHtml}</ul></div><div class="combo-actions"><button onclick="shareComboOnWhatsApp(${c.id})" class="btn-icon-text btn-whatsapp-combo" title="Compartir"><i class="fab fa-whatsapp"></i> WhatsApp</button><button onclick="openLabelGenerator(${c.id})" class="btn-icon-text btn-image-combo" title="Generar Imagen"><i class="fas fa-image"></i></button></div>`;
    cont.appendChild(card);
  });
}
window.shareComboOnWhatsApp = function(id) {
    const combo = combosCache.find(c => c.id === id);
    if (!combo) { alert('Error: Combo no encontrado'); return; }
    const items = combo.items || combo.productos || [];
    let message = `¡OFERTA ESPECIAL! Combo *${combo.nombre}* a un precio irresistible, *¿te guardo uno?*\n\n`;
    const itemsText = items.map(item => `${item.cantidad} x ${item.nombre}`).join('\n');
    if (itemsText) { message += `Incluye:\n${itemsText}\n\n`; }
    message += `Precio: ${formatCurrency(combo.precio)}`;
    const whatsappUrl = `https://api.whatsapp.com/send?text=${encodeURIComponent(message)}`;
    window.open(whatsappUrl, '_blank');
}

window.openLabelGenerator = function(comboId) {
    const combo = combosCache.find(c => c.id === comboId); 
    if (!combo) {
        alert('No se pudo encontrar el combo seleccionado.');
        return;
    }
    
    document.getElementById('etiqueta-visor-imagen').src = combo.imagen || 'https://placehold.co/300x200/e2e8f0/adb5bd?text=Combo';
    document.getElementById('etiqueta-promo-title').innerText = combo.nombre.toUpperCase();
    document.getElementById('etiqueta-promo-price').innerText = formatCurrencyForLabel(combo.precio);
    
    document.getElementById('etiqueta-promo-description').innerHTML = "Descubre la calidad y el ahorro.<br>¿Te Guardamos un Combo?";
    
    const listElement = document.getElementById('etiqueta-promo-list');
    listElement.innerHTML = '';
    const items = combo.items || combo.productos || [];

    items.forEach(item => {
        const listItem = document.createElement('li');
        listItem.innerHTML = `<strong>${item.cantidad}</strong> x <span>${item.nombre}</span>`;
        listElement.appendChild(listItem);
    });

    setTimeout(() => {
        const contentArea = document.getElementById('etiqueta-visor-contenido');
        const textBlock = document.getElementById('etiqueta-text-block');
        
        if (contentArea && textBlock) {
            textBlock.style.fontSize = '1em'; 
            
            if (contentArea.scrollHeight > contentArea.clientHeight) {
                let currentSize = 1;
                while (contentArea.scrollHeight > contentArea.clientHeight && currentSize > 0.5) {
                    currentSize -= 0.02;
                    textBlock.style.fontSize = `${currentSize}em`;
                }
            }
        }
    }, 50);
    
    document.getElementById('label-generator-modal').classList.add('active');
}

document.getElementById('btn-close-label').onclick = function() { document.getElementById('label-generator-modal').classList.remove('active'); }
document.getElementById('btn-download-label').onclick = function() {
    const elementToCapture = document.getElementById('etiqueta-area-captura-final');
    const comboName = document.getElementById('etiqueta-promo-title').innerText;
    if (!elementToCapture) return;
    html2canvas(elementToCapture, { scale: 3, useCORS: true, backgroundColor: '#f3f4f6' }).then(canvas => { 
        const imageURL = canvas.toDataURL('image/png');
        const link = document.createElement('a');
        link.href = imageURL;
        const safeFileName = comboName.replace(/[^a-z0-9]/gi, '_').toLowerCase();
        link.download = `etiqueta_combo_${safeFileName}.png`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }).catch(error => { console.error('Error html2canvas:', error); alert('Error al generar imagen.'); });
}
function copyToClipboard(text, successMessage) {
  if (navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard.writeText(text).then(() => { alert(successMessage); }).catch(err => { fallbackCopyTextToClipboard(text, successMessage); });
  } else { fallbackCopyTextToClipboard(text, successMessage); }
}
function fallbackCopyTextToClipboard(text, successMessage) {
  const textArea = document.createElement("textarea");
  textArea.value = text;
  textArea.style.position = "fixed";
  textArea.style.left = "-9999px";
  textArea.style.top = "-9999px";
  document.body.appendChild(textArea);
  textArea.focus();
  textArea.select();
  try { const successful = document.execCommand('copy'); if (successful) { alert(successMessage); } else { alert('Error: No se pudo copiar el texto.'); } } catch (err) { alert('Error: No se pudo copiar el texto.'); }
  document.body.removeChild(textArea);
}

function resetFormularioCliente() {
    document.getElementById('form-cliente').reset();
}

function showFloating(type, payload){
  const floating = document.getElementById('floatingCard');
  floating.classList.remove('success','error');
  if(type === 'success') floating.classList.add('success');
  if(type === 'error') floating.classList.add('error');
  
  let vencimientoTexto = '—';
  if (payload.vencimiento) {
      const date = new Date(payload.vencimiento);
      const dateOptions = { day: '2-digit', month: '2-digit', year: 'numeric' };
      const timeOptions = { hour: '2-digit', minute: '2-digit' };
      const datePart = date.toLocaleDateString('es-AR', dateOptions);
      const timePart = date.toLocaleTimeString('es-AR', timeOptions);
      vencimientoTexto = `Vence: ${datePart} ${timePart} hs`;
  }

  document.getElementById('floatingTitle').textContent = payload.title || (type==='success'?'Código generado':'Denegado');
  document.getElementById('floatingMsg').textContent = payload.message || '';
  document.getElementById('floatingCode').textContent = payload.codigo || '—';
  document.getElementById('floatingPercent').textContent = payload.valor ? `${payload.valor}%` : '—';
  document.getElementById('floatingVence').textContent = vencimientoTexto;
  
  document.getElementById('btn-whatsapp-send').onclick = () => {
    if(payload.whatsapp && payload.whatsapp.length){
      const phone = payload.whatsapp.replace(/\D/g,'');
      const msg = `Hola ${payload.nombre || ''}, gracias por registrarte en PER & PIE 🍸.\nTu código de descuento del ${payload.valor}% es ${payload.codigo}.\nEs válido por 7 días, de un solo uso, y vence el día ${vencimientoTexto.replace('Vence: ', '').replace(' hs', '').trim()}.\nHay productos que ya tienen descuentos, por lo que no son acumulables.`;
      window.open(`https://wa.me/${phone}?text=${encodeURIComponent(msg)}`,'_blank');
    } else { alert('Número de teléfono inválido para WhatsApp.'); }
  };
  document.getElementById('btn-copy-code').onclick = () => { const code = document.getElementById('floatingCode').textContent; copyToClipboard(code, `✅ Código ${code} copiado al portapapeles.`); };
  
  document.getElementById('btn-close-floating').onclick = () => {
    floating.style.display = 'none';
    resetFormularioCliente(); 
  };
  
  floating.style.display = 'flex'; 
}

function initClientes(sbClient){
  document.getElementById('form-cliente').addEventListener('submit', async (e)=>{
    e.preventDefault();
    const nombre = (document.getElementById('cliente-nombre').value || '').trim();
    const telefono = (document.getElementById('cliente-telefono').value || '').trim();
    const fecha = document.getElementById('cliente-fecha-nacimiento').value || null;
    const direccion = (document.getElementById('cliente-direccion').value || '').trim();
    showFloating('error', { title: 'Procesando...', message: 'Verificando número...', codigo: '—', valor: '—', vencimiento: '' });
    try{
      const normalized = telefono.replace(/\s+/g,'').replace(/[^+\d]/g,'');
      const { data: existing, error: errExist } = await sbClient.from('clientes').select('id').eq('telefono', normalized).limit(1).maybeSingle();
      if(errExist){ showFloating('error',{ title:'Error', message:'Error verificando cliente.' }); return; }
      if(existing){ showFloating('error',{ title:'Denegado', message:`Denegado, el N° ya se encuentra registrado. (${normalized})` }); return; }
      const { error: errInsert } = await sbClient.from('clientes').insert({ nombre, telefono: normalized, direccion: direccion || null, fecha_nacimiento: fecha }).select().single();
      if(errInsert){ showFloating('error',{ title:'Error', message:'No se pudo guardar el cliente.' }); return; }
      let porcentaje = 5;
      const { data: cfg } = await sbClient.from('config').select('config_descuento_compra').limit(1).single();
      if(cfg && cfg.config_descuento_compra) porcentaje = Number(cfg.config_descuento_compra);
      const randomCode = 'PERPIE-' + Math.random().toString(36).substring(2,8).toUpperCase();
      const vencDate = new Date(Date.now() + 7*24*60*60*1000);
      await sbClient.from('descuentos').insert({ nombre, domicilio: direccion, whatsapp: normalized, codigo: randomCode, valor: porcentaje, vencimiento: vencDate.toISOString(), usageType: 'unico' });
      showFloating('success', { title:'Código generado', message:'Código de un solo uso creado correctamente.', codigo: randomCode, valor: porcentaje, vencimiento: vencDate.toISOString(), whatsapp: normalized, nombre });
    }catch(err){ showFloating('error',{ title:'Error', message:'Ocurrió un error inesperado.' }); }
  });
}
function populateVentaSelector() {
    // Esta función ahora gestiona la LISTA DESPLEGABLE DE BÚSQUEDA
    if (!buscadorInput || !resultsListDiv) return;

    const filter = buscadorInput.value || '';
    const lowerFilter = filter.toLowerCase();
    
    // Detectar qué radio está seleccionado
    const radioProducto = document.querySelector('input[name="tipoVenta"][value="productos"]');
    const tipo = (radioProducto && radioProducto.checked) ? 'productos' : 'combos';

    resultsListDiv.innerHTML = '';
    
    // Si el input está vacío y no tiene foco, ocultamos
    if (document.activeElement !== buscadorInput && filter === '') {
        resultsListDiv.classList.remove('active');
        return;
    }

    const filterFn = (item) => {
        const nameMatch = item.nombre.toLowerCase().includes(lowerFilter);
        if (tipo === 'productos' && item.categoria) {
            const categoryMatch = item.categoria.toLowerCase() === lowerFilter;
            const categoryPartial = item.categoria.toLowerCase().includes(lowerFilter);
            return nameMatch || categoryMatch || categoryPartial;
        }
        return nameMatch;
    };

    let resultados = [];
    if (tipo === 'combos') {
        resultados = combosCache.filter(filterFn);
    } else {
        resultados = productosCache.filter(filterFn);
    }

    // Ordenar resultados alfabéticamente
    resultados.sort((a,b) => a.nombre.localeCompare(b.nombre));

    if (resultados.length === 0) {
        resultsListDiv.innerHTML = '<div style="padding:10px; color:#666; text-align:center;">No se encontraron resultados</div>';
    } else {
        resultados.forEach(item => {
            const row = document.createElement('div');
            row.className = 'search-item-row';
            
            // Calculos visuales
            const precio = tipo === 'combos' ? item.precio : (item.precio1 || 0);
            const precioFmt = formatCurrency(precio);
            let stockInfo = '';
            
            // Chequeo stock visual
            let stockReal = 0;
            if (tipo === 'combos') {
                stockReal = item.stockCalculado || 0;
                stockInfo = `(Disp: ${stockReal})`;
            } else {
                stockReal = item.stock || 0;
                if(stockReal <= 0) stockInfo = '(Sin Stock)';
            }

            row.innerHTML = `
                <div class="item-info-text">
                    <span class="item-name">${item.nombre}</span>
                    <span class="item-price">${precioFmt} ${stockInfo}</span>
                </div>
                <button class="btn-add-circle" onclick="agregarAlCarritoDirecto(${item.id}, '${tipo}')">
                    <i class="fas fa-plus"></i>
                </button>
            `;
            
            resultsListDiv.appendChild(row);
        });
    }
    
    resultsListDiv.classList.add('active');
}

// Nueva función global para agregar desde el botón azul
window.agregarAlCarritoDirecto = function(id, tipo) {
    const cant = 1; // Por defecto agrega 1
    
    // Usamos la función interna expuesta en initVentas
    if(window.appAgregarItem) {
        window.appAgregarItem(id, tipo, cant);
        // Opcional: limpiar buscador tras agregar
        buscadorInput.value = '';
        populateVentaSelector();
        buscadorInput.focus();
    } else {
        console.error("Error: appAgregarItem no inicializado");
    }
};

function initVentas(sbClient) {
  const tablaCarrito = document.getElementById('tabla-carrito');
  const inputCodigo = document.getElementById('venta-descuento-aplicado');
  const descuentoFeedback = document.getElementById('descuento-feedback'); 

  // Carrito ahora es accesible para las funciones globales
  let carrito = [];
  let descuentoActual = { codigo: null, valor: 0, id: null, usageType: null };
  let ultimoMensajePedido = '';

  // Exponemos la función de agregar para que el botón azul la use
  window.appAgregarItem = (selId, tipoStr, cant) => {
    const isCombo = (tipoStr === 'combos');
    let item;
    let stockDisponible;
    let costo = 0, ganancia = 0;

    if (isCombo) {
        item = combosCache.find(x => x.id === selId); 
        if (!item) return alert('Combo no encontrado');
        stockDisponible = item.stockCalculado || 0;
        const enCarrito = carrito.filter(c => c.isCombo && c.id === selId).reduce((acc, c) => acc + c.cant, 0);
        
        if ((cant + enCarrito) > stockDisponible) {
            alert(`¡Stock insuficiente! Solo quedan ${stockDisponible}.`);
            return;
        }
        costo = Number(item.costo) || 0;
        ganancia = Number(item.ganancia) || 0;
    } else {
        item = productosCache.find(x => x.id === selId);
        if (!item) return alert('Producto no encontrado');
        stockDisponible = Number(item.stock) || 0;
        const enCarrito = carrito.filter(c => !c.isCombo && c.id === selId).reduce((acc, c) => acc + c.cant, 0);
        
        if ((cant + enCarrito) > stockDisponible) {
            alert(`Stock Insuficiente. Disponible: ${stockDisponible}.`);
            return;
        }
        costo = Number(item.costo) || 0;
        ganancia = Number(item.ganancia1) || 0; 
    }

    const aceptaDescuento = isCombo ? (item.descuentoaplicable === true) : true;
    const contenido = isCombo ? (item.items || item.productos || []) : [];
    
    // Verificar si ya existe en carrito para sumar
    const existenteIndex = carrito.findIndex(c => c.id === selId && c.isCombo === isCombo);
    if (existenteIndex > -1) {
        carrito[existenteIndex].cant += cant;
    } else {
        carrito.push({ 
            id: item.id, 
            nombre: item.nombre, 
            precio: Number(item.precio1 || item.precio || 0), 
            cant, 
            stock: stockDisponible, 
            aceptaDescuento,
            isCombo,
            contenido,
            costo: costo,
            ganancia: ganancia 
        });
    }
    
    renderCarrito();
  };

  // Función para cambiar cantidad desde < 1 >
  window.cambiarCantidadCarrito = (index, delta) => {
      const item = carrito[index];
      if (!item) return;
      
      const nuevaCant = item.cant + delta;
      
      if (nuevaCant <= 0) {
          // Si baja a 0 eliminamos
          carrito.splice(index, 1);
      } else {
          // Validar stock máximo
          if (nuevaCant > item.stock) {
              alert(`No puedes superar el stock disponible (${item.stock}).`);
              return;
          }
          item.cant = nuevaCant;
      }
      renderCarrito();
  };

  function transformarDatosVenta(carritoActual, descuentoObj) {
      const itemsParaGuardar = carritoActual.map(p => {
          if (p.isCombo) {
              return {
                  id: p.id,
                  nombre: p.nombre,
                  cantidad: p.cant || p.cantidad || 1,
                  precioUnitario: p.precio,
                  gananciaUnitaria: p.ganancia || 0,
                  type: 'combo',            
                  items: p.contenido || []  
              };
          } else {
              return {
                  id: p.id,
                  nombre: p.nombre,
                  cantidad: p.cant || p.cantidad || 1,
                  precioUnitario: p.precio,
                  gananciaUnitaria: p.ganancia || 0,
                  type: 'prod'
              };
          }
      });
      let descuentoParaGuardar = null;
      if (descuentoObj && descuentoObj.codigo) {
          const fechaVenc = new Date();
          fechaVenc.setDate(fechaVenc.getDate() + 7); 
          descuentoParaGuardar = {
              ...descuentoObj,
              usagetype: 'single', 
              usageType: 'single',
              vencimiento: fechaVenc.toISOString() 
          };
      }
      return {
          items: itemsParaGuardar,
          descuento: descuentoParaGuardar
      };
  }

  function limpiarVentaCompleta() {
      carrito.length = 0; 
      renderCarrito(); 
      inputCodigo.value = "";
      descuentoActual = { codigo: null, valor: 0, id: null, usageType: null }; 
      descuentoFeedback.textContent = ''; 
      descuentoFeedback.className = ''; 
      actualizarTotales();
      document.getElementById('venta-cliente').value = ''; 
  }

  let validationTimeout;
  async function validarDescuento(codigo) {
    clearTimeout(validationTimeout);
    if (!codigo) {
        descuentoActual = { codigo: null, valor: 0, id: null, usageType: null };
        descuentoFeedback.textContent = ''; 
        descuentoFeedback.className = '';
        actualizarTotales();
        return;
    }

    descuentoFeedback.textContent = 'Verificando...'; 
    descuentoFeedback.className = '';
    validationTimeout = setTimeout(async () => {
        const { data } = await sbClient.from('descuentos')
            .select('*') 
            .eq('codigo', codigo)
            .maybeSingle();

        if (data) {
             if (new Date(data.vencimiento) > new Date()) {
                descuentoActual = { 
                    id: data.id,
                    codigo: data.codigo, 
                    valor: Number(data.valor),
                    usageType: data.usageType || data.usagetype 
                };
                descuentoFeedback.textContent = `✔️`; 
                descuentoFeedback.className = 'feedback-success';
            } else { 
                descuentoActual = { codigo: null, valor: 0, id: null, usageType: null }; 
                descuentoFeedback.textContent = 'Código Vencido';
                descuentoFeedback.className = 'feedback-error'; 
            }
        } else { 
            descuentoActual = { codigo: null, valor: 0, id: null, usageType: null };
            descuentoFeedback.textContent = 'Código Inválido'; 
            descuentoFeedback.className = 'feedback-error'; 
        }
        actualizarTotales();
    }, 400);
  }

  // --- EVENT LISTENERS NUEVOS ---
  // Detectar cambios en los Radio Buttons
  document.querySelectorAll('input[name="tipoVenta"]').forEach(radio => {
      radio.addEventListener('change', () => {
          buscadorInput.value = ''; // Limpiar al cambiar
          buscadorInput.focus();
          populateVentaSelector();
      });
  });

  // Detectar escritura en el buscador
  buscadorInput.addEventListener('input', () => {
      populateVentaSelector();
  });
  
  // Mostrar lista al hacer foco
  buscadorInput.addEventListener('focus', () => {
      populateVentaSelector();
  });
  
  // Ocultar lista al hacer click fuera
  document.addEventListener('click', (e) => {
      if (!e.target.closest('.search-container')) {
          resultsListDiv.classList.remove('active');
      }
  });
  
  // Escuchar inputs de descuento
  inputCodigo.addEventListener('input', () => {
      validarDescuento(inputCodigo.value.trim());
  });
  inputCodigo.addEventListener('change', () => {
      validarDescuento(inputCodigo.value.trim());
  });
// --- FUNCIONES DE AYUDA (AÑADIR) ---

// Función para generar un ID único que usaremos como 'external_reference'
function generateUniqueId() {
    return 'id-' + Date.now().toString(36) + Math.random().toString(36).substring(2, 5);
}

// Función para mostrar el modal del Código QR
function mostrarModalQR(qrImageUrl, total, cliente) {
    // Busca y elimina cualquier modal QR anterior para evitar duplicados
    const existingOverlay = document.getElementById('modal-qr-container');
    if (existingOverlay) existingOverlay.remove();

    // Estructura del modal (usa estilos en línea para simplicidad en el celular)
    const overlay = document.createElement('div');
    overlay.id = 'modal-qr-container';
    overlay.className = 'modal-overlay active';
    overlay.style.cssText = 'position:fixed; top:0; left:0; width:100%; height:100%; background-color:rgba(0,0,0,0.85); z-index:99999; display:flex; align-items:center; justify-content:center; flex-direction:column;';

    const content = document.createElement('div');
    content.className = 'modal-content';
    content.style.cssText = 'background:white; padding:30px; border-radius:15px; text-align:center; max-width:90%; width: 380px;';

    content.innerHTML = `
        <h2 style="color:var(--mp-blue); margin-top:0;"><i class="fas fa-qrcode"></i> Pagar con Mercado Pago</h2>
        <p style="font-size:1rem; font-weight:600; margin-bottom: 5px;">Cliente: ${cliente}</p>
        <p style="font-size:1.8rem; font-weight:900; color:#10b981; margin: 5px 0 15px 0;">Total: $${total.toLocaleString('es-AR')}</p>

        <div style="border: 2px solid var(--mp-blue); padding: 10px; border-radius: 10px; background: #f0f8ff;">
             <img src="${qrImageUrl}" alt="Código QR de Pago" style="width: 100%; max-width: 250px; height: auto; display: block; margin: 0 auto; border-radius: 5px;">
        </div>

        <p style="font-size:0.95rem; font-weight:700; color:#f97316; margin-top: 15px;">
            El estado de la venta se actualizará automáticamente a "PAGADO" en tu base de datos.
        </p>

        <div style="margin-top:20px; display:flex; gap:10px; justify-content:center;">
            <button id="btn-cerrar-qr" class="btn-modern btn-gray" style="width:100%; background:#ef4444; color:white; border:none; padding:12px 25px; border-radius:8px; font-weight:bold; cursor:pointer; font-size:1rem;">
                <i class="fas fa-times"></i> Cerrar
            </button>
        </div>
    `;

    overlay.appendChild(content);
    document.body.appendChild(overlay);

    document.getElementById('btn-cerrar-qr').onclick = () => {
        overlay.remove();
    };
}


// --- FUNCIÓN PRINCIPAL DE PAGO QR (REEMPLAZO DE handlePagarMP) ---
const handlePagarQR = async (total, subtotal, montoDescuento, totalGanancia, totalMiPago, carrito, descuentoActual) => {
    // Tomamos el cliente del input
    const clienteVal = document.getElementById('venta-cliente').value.trim();
    if (!clienteVal) {
        alert('⚠️ El campo "Nombre y Apellido / Domicilio" es obligatorio para generar el QR.');
        document.getElementById('venta-cliente').focus();
        return;
    }

    const btnMP = document.getElementById('btn-pagar-mp');

    // Si el botón ya está deshabilitado, salimos
    if(btnMP.disabled) return;

    const ventaId = generateUniqueId(); // Nuevo ID único (PERPIE-XXXXX)
    const cliente = clienteVal;

    // Mantenemos los cálculos que ya tenías
    const totalMontoFinal = Number(total.toFixed(2));

    // 1. Preparación del array de ítems para el API de Mercado Pago
    const itemsMP = carrito.map(item => ({
        sku: item.isCombo ? `COMBO-${item.id}` : `PROD-${item.id}`,
        name: item.nombre,
        quantity: item.cant,
        unit_price: Number(item.precio.toFixed(2)),
        unit_measure: 'unit',
        code: item.isCombo ? 'combo' : 'product'
    }));


    try {
        btnMP.disabled = true;
        btnMP.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generando QR...';

        // 2. LLAMADA A LA NETLIFY FUNCTION /generate-qr
        const response = await fetch('/.netlify/functions/generate-qr', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                total: totalMontoFinal,
                items: itemsMP,
                venta_id: ventaId // ID interno que usará el Webhook
            })
        });

        const dataQR = await response.json();

        if (!response.ok || !dataQR.qr_data || !dataQR.qr_image) {
            throw new Error(dataQR.error ? dataQR.error.details.message : 'Error al obtener datos del QR.');
        }

        // 3. INSERTAR VENTA EN SUPABASE CON ESTADO "Pendiente QR"
        // Usamos la función transformarDatosVenta que ya tenías
        const datosVenta = transformarDatosVenta(carrito, descuentoActual);

        const { error: errorDB } = await supabaseClient.from('ventas').insert({
            fecha: new Date().toISOString(),
            items: datosVenta.items,
            descuentoAplicado: datosVenta.descuento,
            cliente: cliente,
            venta_id: ventaId, // Clave para el Webhook
            estado_pago: "Pendiente QR", // ESTADO CLAVE PARA EL WEBHOOK
            formaDePago: "Mercado Pago QR",
            subtotal: subtotal,
            montoDescuento: montoDescuento,
            total: totalMontoFinal,
            ganancia: totalGanancia,
            miPago: totalMiPago,
            archivada: false
        });

        if (errorDB) throw new Error("Error guardando venta en DB: " + errorDB.message);

        // 4. Descontar stock inmediatamente
        await updateStockFromSale(carrito);

        // 5. Mostrar el QR al cliente
        mostrarModalQR(dataQR.qr_image, totalMontoFinal, cliente);

        // 6. Limpiar el carrito después de guardar
        limpiarVentaCompleta();

    } catch (error) {
        console.error('Error en el flujo QR:', error);
        alert('❌ Error al procesar el pago QR: ' + (error.message || 'Error desconocido.'));
    } finally {
        btnMP.disabled = false;
        btnMP.innerHTML = '<i class="fas fa-qrcode" style="margin-right: 8px;"></i>Pagar con QR Mercado Pago';
    }
};
// --- FIN SUSTITUCIÓN DE LÓGICA ---
const btnPagarMP = document.getElementById('btn-pagar-mp');
btnPagarMP.addEventListener('click', handlePagarMP);
  const btnEnviarWA = document.getElementById('btn-enviar-pedido-wa');
  btnEnviarWA.addEventListener('click', () => {
      const clienteVal = document.getElementById('venta-cliente').value.trim();
      if (!clienteVal) {
          alert('⚠️ El campo "Nombre y Apellido / Domicilio" es obligatorio.');
          document.getElementById('venta-cliente').focus();
          return;
      }
      if(carrito.length===0) {
          alert('El carrito está vacío.');
          return;
      }
      
      const fechaStr = new Date().toLocaleString('es-AR');
      const sub = carrito.reduce((s,it)=>s+it.precio*it.cant,0);
      const baseDescontable = carrito.reduce((acc, it) => { if(it.aceptaDescuento) return acc + (it.precio * it.cant); return acc; }, 0);
      const desc = baseDescontable * (descuentoActual.valor/100);
      const tot = sub - desc;
      const cliente = document.getElementById('venta-cliente').value.trim() || 'Cliente Ocasional';
      
      const formaPagoDisplay = "a coordinar (Via WhatsApp)";
      
      let html = '<table><thead><tr><th style="text-align:left;">Producto</th><th>Unidad</th><th>Total</th></tr></thead><tbody>';
      carrito.forEach(it => {
          let nombreDisplay = `<span style="font-weight:600;">${it.cant} x ${it.nombre}</span>`;
          if(it.isCombo && it.contenido && it.contenido.length > 0){
              nombreDisplay += '<ul style="margin:4px 0 0 0; padding-left:10px; font-size:0.85em; color:#555; list-style-type:none;">';
              it.contenido.forEach(c => { nombreDisplay += `<li>• ${c.cantidad} x ${c.nombre}</li>`; });
              nombreDisplay += '</ul>';
          }
          html += `<tr>
              <td style="padding:8px 0;">${nombreDisplay}</td>
              <td style="vertical-align:top; padding:8px 4px;">$${it.precio.toLocaleString('es-AR')}</td>
              <td style="vertical-align:top; padding:8px 4px; font-weight:bold;">$${(it.precio * it.cant).toLocaleString('es-AR')}</td>
          </tr>`;
      });
      html += '</tbody></table>';
      html += '<div class="totales">';
      html += `<div style="margin-top:10px;">Cliente: <span style="font-weight:600;">${cliente}</span></div>`;
      html += `<div>Pago: <span style="font-weight:600;">${formaPagoDisplay}</span></div>`;
      if(descuentoActual.codigo) {
          html += `<div style="color:#007bff; font-size:0.9rem; margin-bottom:4px;">Código aplicado: ${descuentoActual.codigo} (${descuentoActual.valor}%)</div>`;
      }
      html += `<div>Sub: $${sub.toLocaleString('es-AR')}</div>`;
      html += `<div>Desc: -$${desc.toLocaleString('es-AR')}</div>`;
      html += `<div style="font-size:1.3rem; color:#059669; margin-top:5px;">Tot: $${tot.toLocaleString('es-AR')}</div>`;
      html += `<div style="margin-to-p:8px;color:#666">${fechaStr}</div></div>`;
      
      document.getElementById('ventaResumenContenido').innerHTML = html;
      document.getElementById('ventaResumenCard').classList.add('show');
      let msg = `🧾 *Pedido PER&PIE (Para coordinar)*\nCliente: ${cliente}\nFecha: ${fechaStr}\n\n`;
      carrito.forEach(it => {
          msg += `• ${it.cant} x ${it.nombre} ($${it.precio.toLocaleString('es-AR')} u.)\n`;
          if(it.isCombo && it.contenido && it.contenido.length > 0){
               it.contenido.forEach(c => { msg += `   . ${c.cantidad} x ${c.nombre}\n`; });
          }
      });
      if(descuentoActual.codigo) {
          msg += `\nCódigo: ${descuentoActual.codigo} (${descuentoActual.valor}% OFF)`;
      }
      msg += `\n\n*Total a Pagar: $${tot.toLocaleString('es-AR')}*\nForma de Pago: ${formaPagoDisplay}`;
      
      ultimoMensajePedido = msg;
      document.getElementById('btnVentaWhatsApp').onclick = async () => {
          const btnConfirmar = document.getElementById('btnVentaWhatsApp');
          btnConfirmar.disabled = true;
          btnConfirmar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';
          const nombreClienteTexto = document.getElementById('venta-cliente').value.trim() || 'Cliente Ocasional';
          const totalGananciaCalculada = carrito.reduce((acc, item) => {
              return acc + (Number(item.ganancia) || 0) * item.cant;
          }, 0) - desc;
          const pagoPorcentaje = Number(globalPagoPorcentaje) || 0;
          const totalMiPagoCalculado = totalGananciaCalculada * (pagoPorcentaje / 100);
          try {
              logMini('Intentando guardar venta (Fiado) en Supabase...');
              const datosTransformados = transformarDatosVenta(carrito, descuentoActual);

              const ventaParaGuardar = {
                  fecha: new Date().toISOString(),
                  items: datosTransformados.items, 
                  descuentoAplicado: datosTransformados.descuento,
                  clienteId: null, 
                  cliente: nombreClienteTexto, 
                  descuentoId: null, 
                  formaDePago: "Fiado (Via WhatsApp)", 
                  subtotal: sub,
                  montoDescuento: desc,
                  total: tot,
                  ganancia: totalGananciaCalculada,
                  miPago: totalMiPagoCalculado,
                  archivada: false 
              };
              const { error } = await sbClient.from('ventas').insert(ventaParaGuardar);

              if (error) {
                  throw new Error(error.message);
              } else {
                  logMini('✅ Venta (Fiado) guardada exitosamente.');
                  const usageType = (descuentoActual.usageType || '').toLowerCase();
                  const singleUseValues = ['unico', 'single', 'soltero'];
                  const isSingleUse = descuentoActual.id && singleUseValues.includes(usageType);
                  if (isSingleUse) {
                      try { await sbClient.from('descuentos').delete().eq('id', descuentoActual.id);
                      } catch (e) {}
                  } 
              }

          } catch (err) {
              logMini(`❌ Error: ${err.message}`);
              alert('Hubo un error al guardar. Intenta de nuevo.');
              btnConfirmar.disabled = false;
              btnConfirmar.innerHTML = '<i class="fab fa-whatsapp"></i> Confirmar por WhatsApp';
              return;
          }

          try {
              await updateStockFromSale(carrito);
              btnConfirmar.innerHTML = '<i class="fas fa-check"></i> Guardado';
          } catch (err) {}

          if (globalAdminWhatsApp) {
              window.open('https://wa.me/' + globalAdminWhatsApp + '?text='+encodeURIComponent(ultimoMensajePedido), '_blank');
          } else {
              window.open('https://wa.me/?text='+encodeURIComponent(ultimoMensajePedido), '_blank');
          }
      };

      document.getElementById('btnVentaCompartir').onclick = () => {
          const msgCompartir = ultimoMensajePedido + "\n\n¡Mirá este pedido que hice en PER & PIE Bebidas!";
          if (navigator.share) {
              navigator.share({ title: 'Mi Pedido en PER & PIE', text: msgCompartir });
          } else {
              window.open('https://wa.me/?text=' + encodeURIComponent(msgCompartir), '_blank');
          }
      };

      document.getElementById('btnVentaCerrar').onclick = () => {
          document.getElementById('ventaResumenCard').classList.remove('show');
          const btnConfirmar = document.getElementById('btnVentaWhatsApp');
          btnConfirmar.disabled = false;
          btnConfirmar.innerHTML = '<i class="fab fa-whatsapp"></i> Confirmar por WhatsApp';
          limpiarVentaCompleta(); 
      };
      const btnPagoModal = document.getElementById('btnVentaPagar');
      if (btnPagoModal) btnPagoModal.style.display = 'none';
  });
  document.getElementById("btn-limpiar-venta-completa").addEventListener("click", () => {
      limpiarVentaCompleta();
  });
  function actualizarTotales() {
    const sub = carrito.reduce((s,it)=>s+it.precio*it.cant,0);
    const baseDescontable = carrito.reduce((acc, it) => { if(it.aceptaDescuento) return acc + (it.precio * it.cant); return acc; }, 0);
    const desc = baseDescontable * (descuentoActual.valor/100);
    document.getElementById('venta-subtotal').textContent = '$' + sub.toLocaleString('es-AR', { minimumFractionDigits: 2 });
    document.getElementById('venta-monto-descuento').textContent = '-$' + desc.toLocaleString('es-AR', { minimumFractionDigits: 2 });
    document.getElementById('venta-total').textContent = '$' + (sub-desc).toLocaleString('es-AR', { minimumFractionDigits: 2 });
  }
  function renderCarrito() {
    const tbody = document.getElementById('tabla-carrito');
    tbody.innerHTML = '';
    if(carrito.length === 0) { tbody.innerHTML = '<tr><td colspan="5" class="cart-empty">El carrito está vacío</td></tr>'; return;
    }
    carrito.forEach((it, i) => {
      const tr = document.createElement('tr');
      const itemInfo = it.isCombo ? it.nombre : `${it.nombre}`; 
      
      tr.innerHTML = `
        <td>${itemInfo}</td>
        <td>$${it.precio.toLocaleString('es-AR')}</td>
        <td>
            <div class="qty-control-wrapper">
                <button class="btn-qty-arrow" onclick="cambiarCantidadCarrito(${i}, -1)">&lt;</button>
                <span class="qty-display">${it.cant}</span>
                <button class="btn-qty-arrow" onclick="cambiarCantidadCarrito(${i}, 1)">&gt;</button>
            </div>
        </td>
        <td>$${(it.precio*it.cant).toLocaleString('es-AR')}</td>
        <td style="text-align:right;">
            <button data-i="${i}" class="btn-icon-small" onclick="cambiarCantidadCarrito(${i}, -${it.cant})"><i class="fas fa-trash"></i></button>
        </td>`;
      tbody.appendChild(tr);
    });
    actualizarTotales();
  }
  
}


async function updateStockFromSale(cart) {
    if (!cart || cart.length === 0) return;

    for (const item of cart) {
        if (item.isCombo) {
            const comboDef = combosMasterCache.find(c => c.id === item.id);
            if (!comboDef) continue;
            
            const comboItems = comboDef.items || comboDef.productos || [];
            for (const recipeItem of comboItems) {
                const productName = recipeItem.nombre;
                const productToUpdate = productosCache.find(p => p.nombre.toLowerCase().trim() === productName.toLowerCase().trim());
                
                if (productToUpdate) {
                    const quantityToDecrement = (recipeItem.cantidad || 0) * item.cant;
                    await decrementProductStock(productToUpdate.id, quantityToDecrement);
                }
            }
        } else {
            await decrementProductStock(item.id, item.cant);
        }
    }
}

async function decrementProductStock(productId, quantity) {
    if (!productId || !quantity || quantity <= 0) return;
    try {
        await supabaseClient.rpc('decrement_stock', {
            p_id: productId,
            p_qty: quantity
        });
    } catch (err) {
        console.error(err);
    }
}

// Función notifyAdminByWhatsApp ELIMINADA del flujo automático.

document.getElementById('btn-generar-pdf')?.addEventListener('click', async () => {
  try {
    const sb = supabaseClient; 
    if (!sb) return;
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF("p", "pt", "a4");
    
    doc.setFont("helvetica", "bold"); doc.setFontSize(20); doc.text("PER & PIE Bebidas - Lista de Precios", 300, 40, { align: "center" });
    doc.setFontSize(11); doc.setFont("helvetica", "normal"); doc.text("WhatsApp 342 5993971 / 3483 483892", 300, 58, { align: "center" });
    doc.text("Solo Ventas En Línea, se retira por E. Zeballos 4327 P.A. Santa Fe, Capital", 300, 72, { align: "center" });
    doc.setFontSize(9); doc.text("Generado el: " + new Date().toLocaleString("es-AR"), 300, 88, { align: "center" });
    
    let y = 120;
    const productos = productosCache;
    
    const porCategoria = {}; 
    productos.forEach(p => { 
        const cat = p.categoria || "SIN CATEGORÍA"; 
        if (!porCategoria[cat]) porCategoria[cat] = []; 
        porCategoria[cat].push(p); 
    });

    for (const categoria in porCategoria) {
      doc.setFillColor(40, 60, 90); doc.rect(40, y, 515, 28, "F");
      doc.setFont("helvetica", "bold"); doc.setFontSize(14); doc.setTextColor(255, 255, 255); doc.text(categoria, 298, y + 19, { align: "center" });
      y += 40;

      const bodyData = porCategoria[categoria].map(p => {
          let precioCell;
          if (p.stock === 0) {
              precioCell = { content: "Sin Stock", styles: { textColor: [239, 68, 68] } };
          } else {
              precioCell = (typeof p.precio1 === 'number') ? "$ " + Number(p.precio1).toLocaleString("es-AR") : "-";
          }
          return [ p.nombre, "Unidad", precioCell ];
      });

      doc.autoTable({ 
          startY: y, 
          head: [["Producto", "Presentación", "Precio"]], 
          body: bodyData, 
          theme: "grid", 
          styles: { fontSize: 11 }, 
          headStyles: { fillColor: [240, 240, 240], textColor: 20, halign: "center", fontStyle: "bold" }, 
          bodyStyles: { halign: "center" }, 
          margin: { left: 40, right: 40 }, 
          didDrawPage: data => { y = data.cursor.y + 25; } 
      });
      
      if (y > 700) { doc.addPage(); y = 40; }
    }
    doc.save(`Lista_Precios_PER&PIE_${new Date().toISOString().slice(0,10)}.pdf`);
  } catch (err) { 
    console.error("Error generando PDF:", err); 
    alert("Error al generar la lista de precios.");
  }
});
async function cargarTablaVentas() {
    logMini('Cargando datos de ventas...');
    const tablaBody = document.getElementById('tabla-ventas');
    const totalGananciaDisplay = document.getElementById('total-ganancia');
    const totalMiPagoDisplay = document.getElementById('total-mi-pago');
    const totalMontoDisplay = document.getElementById('total-monto-ventas');
    const totalMontoNetoDisplay = document.getElementById('total-monto-neto');

    if (tablaBody) {
        tablaBody.innerHTML = '<tr><td colspan="9" style="text-align:center;">Cargando...</td></tr>';
    }

    // --- FILTRO CLAVE: neq('estado_pago', 'Pendiente QR') ---
    const { data: ventas, error } = await supabaseClient
        .from('ventas')
        .select('*')
        .neq('estado_pago', 'Pendiente QR') // <-- ESTE FILTRO ES LA CLAVE DE LA CORRECCIÓN
        .order('fecha', { ascending: false });
    // --- FIN FILTRO ---

    if (error) {
        console.error('Error cargando ventas:', error);
        if (tablaBody) {
            tablaBody.innerHTML = '<tr><td colspan="9" style="text-align:center; color:red;">Error al cargar ventas.</td></tr>';
        }
        return;
    }

    let totalGanancia = 0;
    let totalMiPago = 0;
    let totalBrutoVentas = 0;
    let totalNetoRecibido = 0;

    if (tablaBody) {
        tablaBody.innerHTML = '';
    }

    ventas.forEach(venta => {
        totalGanancia += venta.ganancia || 0;
        totalMiPago += venta.miPago || 0;
        totalBrutoVentas += venta.total || 0;

        const montoNetoVenta = venta.monto_recibido_neto || venta.total || 0;
        totalNetoRecibido += montoNetoVenta;

        if (tablaBody) {
            const tr = document.createElement('tr');
            const estadoColor = venta.estado_pago === 'PAGADO' ? 'var(--accent-green)' : (venta.estado_pago === 'Fiado' ? '#ef4444' : '#f59e0b');
            const fechaStr = new Date(venta.fecha).toLocaleString('es-AR', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });

            const totalDisplay = `$${(venta.total || 0).toLocaleString('es-AR')}`;
            const montoNetoDisplay = venta.formaDePago && venta.formaDePago.includes('Mercado Pago')
                                      ? `$${montoNetoVenta.toLocaleString('es-AR')} (Neto)` : 'N/A';

            tr.innerHTML = `
                <td style="font-size:0.85rem;">${fechaStr}</td>
                <td style="font-weight:600;">${venta.cliente || 'N/A'}</td>
                <td style="text-align:center;">${venta.items ? venta.items.length : 0}</td>
                <td style="color:${estadoColor}; font-weight:bold;">${venta.estado_pago || 'N/A'}</td>
                <td>${venta.formaDePago || 'N/A'}</td>
                <td style="font-weight:bold; color:var(--text-main);">${totalDisplay}</td>
                <td style="font-size:0.8rem; color:var(--accent-pink);">${montoNetoDisplay}</td>
                <td>$${(venta.ganancia || 0).toLocaleString('es-AR')}</td>
                <td>$${(venta.miPago || 0).toLocaleString('es-AR')}</td>
            `;
            tablaBody.appendChild(tr);
        }
    });

    if (totalGananciaDisplay) totalGananciaDisplay.textContent = `$${totalGanancia.toLocaleString('es-AR', { minimumFractionDigits: 2 })}`;
    if (totalMiPagoDisplay) totalMiPagoDisplay.textContent = `$${totalMiPago.toLocaleString('es-AR', { minimumFractionDigits: 2 })}`;
    if (totalMontoDisplay) totalMontoDisplay.textContent = `$${totalBrutoVentas.toLocaleString('es-AR', { minimumFractionDigits: 2 })}`;
    if (totalMontoNetoDisplay) totalMontoNetoDisplay.textContent = `$${totalNetoRecibido.toLocaleString('es-AR', { minimumFractionDigits: 2 })}`;

    logMini('Ventas cargadas exitosamente.');
}
document.addEventListener('DOMContentLoaded', async () => {
  logMini('App iniciada.');
  
  await conectarYCargarTodo(); 
  // --- NUEVO: Lógica del Buscador de Stock ---
  const inputStock = document.getElementById('stock-search-input');
  if (inputStock) {
      inputStock.addEventListener('input', (e) => {
          const termino = e.target.value.toLowerCase();
          
          // Filtramos usando la variable global 'productosCache'
          const filtrados = productosCache.filter(p => {
              const nombreMatch = p.nombre && p.nombre.toLowerCase().includes(termino);
              const catMatch = p.categoria && p.categoria.toLowerCase().includes(termino);
              return nombreMatch || catMatch;
          });

          // Volvemos a dibujar la tabla con los resultados
          renderTable(filtrados);
      });
  }

  // --- Lógica de Vistas (Limpia) ---

  const params = new URLSearchParams(window.location.search);
  // Si hay parámetros en la URL, asumimos que intenta abrir la vista de ventas, sino la de inicio.
  if (params.toString().length > 0) {
      switchView('ventas');
  } else {
      switchView('inicio');
  }
});
</script>

<a href="https://wa.me/5493425993971?text=Hola%20PER%26PIE!%20Quiero%20hacer%20una%20consulta." class="whatsapp-float" target="_blank" title="Chateá con nosotros"><img src="https://cdn.jsdelivr.net/gh/simple-icons/simple-icons/icons/whatsapp.svg" alt="WhatsApp" class="whatsapp-icon"><span class="whatsapp-tooltip">💬 Chateá con nosotros</span></a>

</body>
</html>
